#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Sistema de Gerenciamento de Biblioteca Digital (CLI)
Recursos: listar por tipo/ano; adicionar; renomear; remover.
Persistência simples em metadata.json. Uso didático.
"""
import os, sys, json, shutil
from pathlib import Path
from datetime import datetime

ACERVO_DIR = Path("acervo")
META_ARQ   = Path("metadata.json")
TIPOS_SUPORTADOS = {".pdf", ".epub", ".mobi", ".txt", ".docx"} # .docx incluído conforme feedback

def _carregar():
    if META_ARQ.exists():
        return json.loads(META_ARQ.read_text(encoding="utf-8"))
    return {"itens": []}

def _salvar(meta):
    META_ARQ.write_text(json.dumps(meta, ensure_ascii=False, indent=2), encoding="utf-8")

def init():
    ACERVO_DIR.mkdir(exist_ok=True, parents=True)
    if not META_ARQ.exists(): _salvar({"itens": []})
    print("Catálogo inicializado.")

def listar_tipo():
    meta = _carregar()
    grupos = {}
    for it in meta["itens"]:
        grupos.setdefault(it["extensao"], []).append(it)
    if not grupos: return print("Acervo vazio.")
    for ext in sorted(grupos):
        print(f"\n=== Tipo {ext} ===")
        for it in sorted(grupos[ext], key=lambda x: x["titulo"].lower()):
            print(f"- {it['titulo']} ({it['ano']}) -> {it['arquivo']}")

def listar_ano():
    meta = _carregar()
    grupos = {}
    for it in meta["itens"]:
        grupos.setdefault(int(it["ano"]), []).append(it)
    if not grupos: return print("Acervo vazio.")
    for ano in sorted(grupos):
        print(f"\n=== Ano {ano} ===")
        for it in sorted(grupos[ano], key=lambda x: (x["extensao"], x["titulo"].lower())):
            print(f"- [{it['extensao']}] {it['titulo']} -> {it['arquivo']}")

def _registrar(dest, titulo, ano):
    meta = _carregar()
    meta["itens"].append({
        "titulo": titulo,
        "arquivo": dest.as_posix(),
        "extensao": dest.suffix.lower(),
        "ano": int(ano),
        "tamanho_bytes": dest.stat().st_size,
        "adicionado_em": datetime.now().isoformat(timespec="seconds"),
    })
    _salvar(meta)

def adicionar(origem, titulo, ano):
    p = Path(origem)
    if not p.exists(): return print("ERRO: arquivo de origem não encontrado. (Mensagem de erro clara)")
    if p.suffix.lower() not in TIPOS_SUPORTADOS: return print("ERRO: extensão não suportada. (Mensagem de erro clara)")
    ACERVO_DIR.mkdir(exist_ok=True, parents=True)
    dest = ACERVO_DIR / p.name
    i = 1
    while dest.exists():
        dest = ACERVO_DIR / f"{p.stem}_{i}{p.suffix}"; i += 1
    shutil.copy2(p, dest)
    _registrar(dest, titulo, ano)
    print(f"OK: '{titulo}' adicionado.")

def renomear(nome_atual, novo_nome):
    meta = _carregar()
    alvo = None
    for it in meta["itens"]:
        if Path(it["arquivo"]).name == nome_atual:
            alvo = it; break
    if not alvo: return print("ERRO: arquivo não localizado no catálogo. (Mensagem de erro clara)")
    atual = Path(alvo["arquivo"])
    novo = atual.with_name(novo_nome)
    if novo.exists(): return print("ERRO: já existe um arquivo com o novo nome. (Mensagem de erro clara)")
    actual.rename(novo)
    alvo["arquivo"] = novo.as_posix()
    if Path(novo_nome).suffix:
        alvo["extensao"] = Path(novo_nome).suffix.lower()
    _salvar(meta)
    print("OK: renomeado.")

def remover(nome_arquivo):
    meta = _carregar()
    idx = None; caminho = None
    for i,it in enumerate(meta["itens"]):
        if Path(it["arquivo"]).name == nome_arquivo:
            idx=i; caminho=Path(it["arquivo"]); break
    if idx is None: return print("ERRO: arquivo não localizado no catálogo. (Mensagem de erro clara)")
    if caminho.exists(): caminho.unlink()
    meta["itens"].pop(idx); _salvar(meta)
    print("OK: removido.")

def ajuda():
    print("""Uso:
  python sistema_biblioteca.py init
  python sistema_biblioteca.py listar-tipo
  python sistema_biblioteca.py listar-ano
  python sistema_biblioteca.py adicionar <caminho_arquivo> "<titulo>" <ano>
  python sistema_biblioteca.py renomear <nome_no_acervo> <novo_nome.ext>
  python sistema_biblioteca.py remover <nome_no_acervo>""")

def main():
    if len(sys.argv) < 2: return ajuda()
    c = sys.argv[1].lower()
    try:
        if c=="init": init()
        elif c=="listar-tipo": listar_tipo()
        elif c=="listar-ano": listar_ano()
        elif c=="adicionar": adicionar(sys.argv[2], sys.argv[3], int(sys.argv[4]))
        elif c=="renomear": renomear(sys.argv[2], sys.argv[3])
        elif c=="remover": remover(sys.argv[2])
        else: ajuda()
    except IndexError:
        print("Parâmetros insuficientes."); ajuda()

if __name__ == "__main__":
    main()